<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽµ Music Visualizer</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #visualizer {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    
    #status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
    }
    
    .connected { color: #00ff00; }
    .disconnected { color: #ff4444; }
  </style>
</head>
<body>

  <canvas id="visualizer"></canvas>
  <div id="status">ðŸ”„ Initializing...</div>

  <script type="module">
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DISCORD SDK INTEGRATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    import { DiscordSDK } from 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@latest/+esm';
    
    const CLIENT_ID = '1448335123639697499';
    const WS_URL = 'wss://music-visualizer-4tbg.onrender.com';
    
    let discordSdk;
    let isInDiscord = false;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZE DISCORD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function initDiscord() {
      try {
        updateStatus('ðŸ”„ Connecting to Discord...');
        
        discordSdk = new DiscordSDK(CLIENT_ID);
        await discordSdk.ready();
        
        const auth = await discordSdk.commands.authenticate({
          scopes: ['identify', 'guilds']
        });
        
        console.log('âœ… Discord Ready:', auth.user.username);
        
        // Set activity status
        await discordSdk.commands.setActivity({
          activity: {
            type: 0,
            details: 'ðŸŽµ Visualizing music',
            state: 'Real-time 60 FPS'
          }
        });
        
        isInDiscord = true;
        updateStatus('âœ… Running in Discord', true);
        
      } catch (error) {
        console.log('â„¹ï¸ Not in Discord, running standalone');
        updateStatus('âœ… Running standalone', true);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VISUALIZER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    let frequencies = new Array(64).fill(0);
    let ws;
    
    function connectWebSocket() {
      updateStatus('ðŸ”„ Connecting to audio...', false);
      
      ws = new WebSocket(WS_URL);
      
      ws.onopen = () => {
        console.log('âœ… Connected to audio stream');
        updateStatus('ðŸŽµ Connected â€¢ Playing', true);
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'fft') {
          frequencies = data.frequencies;
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        updateStatus('âŒ Connection error', false);
      };
      
      ws.onclose = () => {
        console.log('WebSocket closed, reconnecting...');
        updateStatus('ðŸ”„ Reconnecting...', false);
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DRAWING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let hue = 0;
    
    function draw() {
      // Clear with fade effect
      ctx.fillStyle = 'rgba(26, 26, 46, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const barWidth = canvas.width / frequencies.length;
      
      frequencies.forEach((value, index) => {
        const barHeight = (value / 255) * canvas.height * 0.8;
        const x = index * barWidth;
        const y = canvas.height - barHeight;
        
        // Rainbow gradient
        const gradient = ctx.createLinearGradient(x, y, x, canvas.height);
        gradient.addColorStop(0, `hsl(${(hue + index * 3) % 360}, 100%, 50%)`);
        gradient.addColorStop(1, `hsl(${(hue + index * 3 + 60) % 360}, 100%, 30%)`);
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth - 2, barHeight);
      });
      
      hue = (hue + 0.5) % 360;
      
      requestAnimationFrame(draw);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATUS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateStatus(message, isConnected = false) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = isConnected ? 'connected' : 'disconnected';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RESIZE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    (async () => {
      // Check if in Discord iframe
      if (window.location.ancestorOrigins?.length > 0 || window.parent !== window) {
        await initDiscord();
      } else {
        updateStatus('âœ… Running standalone', true);
      }
      
      connectWebSocket();
      draw();
    })();
    
  </script>

</body>
</html>
